<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è±çš„é£²æ–™æ—¥èªŒ</title>
    
    <!-- PWA é…ç½®ï¼šé€™éƒ¨åˆ†æ§åˆ¶åŠ å…¥ä¸»ç•«é¢å¾Œçš„æ¨£å­ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="è±ã®æ—¥èªŒ">
    
    <!-- æ–‡é’æ—¥ç³»é¢¨åœ–ç¤ºï¼šæ¡ç”¨æ‰‹ç¹ªæ„Ÿç·šæ¢èŒ¶æ¯ -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/plasticine/200/tea-cup.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/plasticine/200/tea-cup.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --m-pink: #FFD1DC;
            --m-blue: #BAE1FF;
            --m-yellow: #FFF9DB;
            --m-green: #BFFCC6;
            --m-beige: #F9F6F2; /* æ—¥ç³»ç±³è‰²åº• */
            --text-main: #5D544B;
        }
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--m-beige); 
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        .serif-title { font-family: 'Noto Serif TC', serif; }
        
        .paper-card {
            background: white;
            border-radius: 28px;
            box-shadow: 0 10px 25px -5px rgba(93, 84, 75, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.7);
        }

        /* é¦¬å¡é¾è‰²ç³»æŒ‰éˆ• */
        .option-btn {
            transition: all 0.2s ease;
            border-radius: 12px;
            font-size: 13px;
            padding: 8px 12px;
            border: 1.5px solid #F2EEE9;
            background: white;
            color: #A39689;
            font-weight: 500;
        }
        .option-btn.active-ice { background: var(--m-blue); border-color: var(--m-blue); color: #4A6070; font-weight: 700; }
        .option-btn.active-sugar { background: var(--m-pink); border-color: var(--m-pink); color: #704A55; font-weight: 700; }
        .option-btn.active-top { background: var(--m-green); border-color: var(--m-green); color: #4A704D; font-weight: 700; }

        .btn-click { cursor: pointer; transition: transform 0.1s; }
        .btn-click:active { transform: scale(0.96); }

        /* æ—¥æ›†åœ“è§’æ ¼å­ */
        .calendar-day {
            aspect-ratio: 1;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            position: relative;
        }
        .has-record::after {
            content: '';
            position: absolute;
            bottom: 6px;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--m-pink);
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen opacity-0 transition-opacity duration-500" id="body-content">

    <div id="app" class="max-w-md mx-auto space-y-5">
        
        <!-- Header -->
        <header class="flex justify-between items-end px-2 py-4 pt-6">
            <div>
                <p id="greeting" class="text-[10px] font-bold text-stone-400 tracking-[0.2em] mb-1 uppercase">Loading...</p>
                <h1 class="text-3xl font-black serif-title">è±çš„é£²æ–™æ—¥èªŒ</h1>
            </div>
            <div id="cloud-status" class="text-[9px] bg-white/80 px-3 py-1.5 rounded-full border border-stone-100 flex items-center gap-1.5 font-bold text-stone-400 shadow-sm">
                <i data-lucide="refresh-cw" class="w-3 h-3 animate-spin"></i> åŒæ­¥ä¸­
            </div>
        </header>

        <!-- å¥åº·æŒ‡æ•¸èˆ‡çµ±è¨ˆçœ‹æ¿ -->
        <div class="paper-card p-6 space-y-6 relative overflow-hidden">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2 bg-stone-100/50 px-4 py-2 rounded-2xl">
                    <button onclick="changeMonth(-1)" class="btn-click text-stone-400"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    <span id="display-month" class="text-sm font-black tracking-tighter min-w-[80px] text-center">2024 / 01</span>
                    <button onclick="changeMonth(1)" class="btn-click text-stone-400"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>
                <div class="w-9 h-9 bg-[#FFF9DB] rounded-full flex items-center justify-center">
                    <i data-lucide="sparkles" class="text-[#D4A373] w-4 h-4"></i>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <p class="text-[10px] font-bold text-stone-300 uppercase tracking-widest">æœ¬æœˆæ”¯å‡º</p>
                    <h2 class="text-3xl font-black text-stone-700 leading-none">$<span id="stat-price">0</span></h2>
                </div>
                <div class="text-right space-y-1">
                    <p class="text-[10px] font-bold text-stone-300 uppercase tracking-widest">æœ¬æœˆæ¯æ•¸</p>
                    <h2 class="text-3xl font-black text-stone-700 leading-none"><span id="stat-cups">0</span> <span class="text-sm font-medium">æ¯</span></h2>
                </div>
            </div>

            <!-- å¥åº·æŒ‡æ•¸ (éœ€æ±‚ 7) -->
            <div class="pt-2 space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-[11px] font-bold text-stone-500 flex items-center gap-1">
                        <i data-lucide="heart" class="w-3 h-3 text-pink-300"></i> å¥åº·æŒ‡æ•¸
                    </span>
                    <span id="health-score-text" class="text-xs font-black text-stone-400">100%</span>
                </div>
                <div class="w-full h-2.5 bg-stone-100 rounded-full overflow-hidden border border-white">
                    <div id="health-progress" class="h-full bg-gradient-to-r from-green-200 to-blue-200 transition-all duration-1000 shadow-inner" style="width: 100%"></div>
                </div>
                <p id="health-tip" class="text-[10px] text-stone-400 italic font-medium text-center">ä»Šå¤©ä¹Ÿè¦è¨˜å¾—å¤šå–æ°´å–”ï¼</p>
            </div>
        </div>

        <!-- æ—¥æ›†å€å¡Š -->
        <div class="paper-card p-6">
            <div class="grid grid-cols-7 text-center text-[9px] font-black text-stone-300 uppercase tracking-widest mb-4">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-2">
                <!-- JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

        <!-- é å°¾å°çµ±è¨ˆ -->
        <div class="grid grid-cols-2 gap-4 pb-12">
            <div class="paper-card p-5 space-y-2">
                <p class="text-[9px] font-black text-stone-300 uppercase tracking-tighter">æœ€æ„›å“é …</p>
                <p id="top-item" class="text-sm font-bold truncate">å°šç„¡ç´€éŒ„</p>
            </div>
            <div class="paper-card p-5 space-y-2">
                <p class="text-[9px] font-black text-stone-300 uppercase tracking-tighter">å¸¸ç”¨åº—å®¶</p>
                <p id="top-shop" class="text-sm font-bold truncate">å°šç„¡ç´€éŒ„</p>
            </div>
        </div>
    </div>

    <!-- ç´€éŒ„å½ˆçª— (éœ€æ±‚ 1, 2, 3, 4) -->
    <div id="modal-overlay" class="fixed inset-0 bg-stone-900/40 backdrop-blur-md hidden z-50 items-end justify-center transition-all duration-300">
        <div class="bg-white w-full max-w-md rounded-t-[40px] shadow-2xl p-8 space-y-6 max-h-[90vh] overflow-y-auto no-scrollbar border-t-4 border-white">
            <div class="flex justify-between items-center">
                <h3 id="modal-date-title" class="text-xl font-black serif-title text-stone-700">è¨˜ä¸‹ä¸€æ¯ç¾å¥½</h3>
                <button onclick="closeModal()" class="w-10 h-10 flex items-center justify-center bg-stone-50 rounded-full text-stone-400 btn-click">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div id="entries-container" class="space-y-8">
                <!-- JS æ¸²æŸ“å¤šæ¯ç´€éŒ„ -->
            </div>

            <button id="btn-save" onclick="saveToCloud()" class="btn-click w-full bg-[#5D544B] text-white py-4 rounded-2xl font-bold text-lg shadow-xl shadow-stone-200">
                ä¿å­˜åˆ°é›²ç«¯
            </button>
            <div class="h-8"></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-stone-800/90 text-white px-8 py-3 rounded-full text-[11px] font-bold shadow-2xl z-[100] opacity-0 pointer-events-none transition-all duration-300"></div>

    <script>
        // åˆå§‹åŒ– Firebase
        const firebaseConfig = JSON.parse(__firebase_config);
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'xuan-drink-pwa-v1';

        // é¸é …è¨­å®š (éœ€æ±‚ 2, 3)
        const iceOpts = ['å›ºå®š', 'æ­£å¸¸', 'å°‘å†°', 'å¾®å†°', 'å»å†°', 'å¸¸æº«', 'ç†±çš„'];
        const sugarOpts = ['å›ºå®š', 'æ­£å¸¸', 'å°‘ç³–', 'åŠç³–', 'å¾®ç³–', 'ä¸€åˆ†', 'ç„¡ç³–'];
        const topOpts = ['çç ', 'æ³¢éœ¸', 'æ¤°æœ', 'èŠ‹åœ“', 'ä»™è‰', 'å¸ƒä¸'];

        let state = {
            user: null,
            viewDate: new Date(),
            records: {}, // é›²ç«¯è³‡æ–™ (éœ€æ±‚ 5)
            activeKey: null,
            tempData: [{}, {}] // æš«å­˜è©²æ—¥æœŸçš„å¤šæ¯ç´€éŒ„
        };

        // æ ¸å¿ƒï¼šåŒæ­¥æ™‚é–“èˆ‡ç•«é¢
        function syncUI() {
            state.viewDate = new Date(); // å¼·åˆ¶æŠ“å–ç•¶å‰æ™‚é–“
            updateMonthHeader();
            renderCalendar();
            setGreeting();
            updateStats();
            document.getElementById('body-content').classList.remove('opacity-0');
            lucide.createIcons();
        }

        function updateMonthHeader() {
            const y = state.viewDate.getFullYear();
            const m = state.viewDate.getMonth() + 1;
            document.getElementById('display-month').innerText = `${y} / ${String(m).padStart(2,'0')}`;
        }

        function setGreeting() {
            const hr = new Date().getHours();
            const g = hr < 11 ? "Good Morning" : hr < 17 ? "Good Afternoon" : "Good Evening";
            document.getElementById('greeting').innerText = g;
        }

        function changeMonth(step) {
            state.viewDate.setMonth(state.viewDate.getMonth() + step);
            updateMonthHeader();
            renderCalendar();
            updateStats();
        }

        // æ¸²æŸ“æ—¥æ›†
        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            if (!grid) return;
            grid.innerHTML = '';

            const y = state.viewDate.getFullYear(), m = state.viewDate.getMonth();
            const first = new Date(y, m, 1).getDay();
            const days = new Date(y, m+1, 0).getDate();
            const today = new Date();
            const isThisMonth = today.getFullYear() === y && today.getMonth() === m;

            for(let i=0; i<first; i++) grid.appendChild(document.createElement('div'));

            for(let d=1; d<=days; d++) {
                const key = `${y}-${m+1}-${d}`;
                const drinks = (state.records[key] || []).filter(r => r && r.item);
                const hasData = drinks.length > 0;
                const isToday = isThisMonth && today.getDate() === d;
                
                const btn = document.createElement('button');
                btn.onclick = () => openModal(key);
                btn.className = `calendar-day btn-click ${hasData ? 'bg-stone-800 text-white font-black' : isToday ? 'border-2 border-stone-800 text-stone-800' : 'text-stone-400 hover:bg-white'}`;
                if(hasData) btn.classList.add('has-record');
                btn.innerHTML = `<span>${d}</span>`;
                grid.appendChild(btn);
            }
        }

        // æ›´æ–°çµ±è¨ˆèˆ‡å¥åº·æŒ‡æ•¸ (éœ€æ±‚ 1, 7)
        function updateStats() {
            const y = state.viewDate.getFullYear(), m = state.viewDate.getMonth() + 1;
            let totalCost = 0, totalCups = 0, items = {}, shops = {}, penalty = 0;

            Object.keys(state.records).forEach(key => {
                if(key.startsWith(`${y}-${m}-`)) {
                    (state.records[key] || []).forEach(r => {
                        if(r && r.item) {
                            totalCost += Number(r.price || 0);
                            totalCups++;
                            items[r.item] = (items[r.item] || 0) + 1;
                            if(r.shop) shops[r.shop] = (shops[r.shop] || 0) + 1;
                            
                            // ç°¡æ˜“å¥åº·æ‰£åˆ†é‚è¼¯
                            if(['æ­£å¸¸', 'å›ºå®š', 'å°‘ç³–'].includes(r.sugar)) penalty += 20;
                            else if(r.sugar === 'åŠç³–') penalty += 10;
                            else if(['å¾®ç³–', 'ä¸€åˆ†'].includes(r.sugar)) penalty += 5;
                        }
                    });
                }
            });

            document.getElementById('stat-price').innerText = totalCost;
            document.getElementById('stat-cups').innerText = totalCups;
            
            const topItem = Object.entries(items).sort((a,b)=>b[1]-a[1])[0];
            const topShop = Object.entries(shops).sort((a,b)=>b[1]-a[1])[0];
            document.getElementById('top-item').innerText = topItem ? topItem[0] : 'å°šç„¡ç´€éŒ„';
            document.getElementById('top-shop').innerText = topShop ? topShop[0] : 'å°šç„¡ç´€éŒ„';

            // å¥åº·æŒ‡æ•¸è¨ˆç®—
            const healthScore = Math.max(0, 100 - penalty);
            document.getElementById('health-score-text').innerText = healthScore + '%';
            const progress = document.getElementById('health-progress');
            progress.style.width = healthScore + '%';
            
            const tip = document.getElementById('health-tip');
            if(healthScore > 80) tip.innerText = "é€™å€‹æœˆéå¸¸å¥åº·ï¼Œç¹¼çºŒä¿æŒï¼âœ¨";
            else if(healthScore > 50) tip.innerText = "é£²æ–™å¥½å–ï¼Œä½†è¦æ³¨æ„ç³–åˆ†å–”ã€‚ğŸµ";
            else tip.innerText = "è­¦å‘Šï¼é€™å€‹æœˆæ”å–å¤ªå¤šç³–åˆ†äº†å•¦ï¼ğŸš«";
        }

        function openModal(key) {
            state.activeKey = key;
            const p = key.split('-');
            document.getElementById('modal-date-title').innerText = `${p[1]}æœˆ${p[2]}æ—¥ é£²å“ç´€éŒ„`;
            // è®€å–è©²æ—¥æš«å­˜æˆ–åˆå§‹åŒ–
            state.tempData = JSON.parse(JSON.stringify(state.records[key] || [{}, {}]));
            renderEntries();
            document.getElementById('modal-overlay').classList.replace('hidden', 'flex');
            lucide.createIcons();
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.replace('flex', 'hidden');
        }

        // æ¸²æŸ“ç·¨è¼¯è¡¨å–® (éœ€æ±‚ 1, 2, 3, 4)
        function renderEntries() {
            const container = document.getElementById('entries-container');
            container.innerHTML = '';
            state.tempData.forEach((data, idx) => {
                const section = document.createElement('div');
                section.className = "space-y-5 bg-stone-50/50 p-6 rounded-[24px] border border-stone-100";
                section.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-[10px] font-black tracking-widest text-stone-300">DRINK ${idx+1}</span>
                        <div class="flex items-center gap-1 bg-white px-3 py-1.5 rounded-full border border-stone-100 shadow-sm">
                            <span class="text-[11px] font-bold text-stone-300">$</span>
                            <input type="number" value="${data.price||''}" oninput="updateTemp(${idx}, 'price', this.value)" class="w-12 bg-transparent text-sm font-black outline-none" placeholder="0">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" value="${data.shop||''}" oninput="updateTemp(${idx}, 'shop', this.value)" class="w-full p-4 bg-white rounded-2xl text-sm border-none shadow-sm outline-none" placeholder="åº—å®¶">
                        <input type="text" value="${data.item||''}" oninput="updateTemp(${idx}, 'item', this.value)" class="w-full p-4 bg-white rounded-2xl text-sm border-none shadow-sm outline-none" placeholder="å“é …åç¨±">
                    </div>
                    <div class="space-y-2">
                        <p class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">å†°å¡Š</p>
                        <div class="flex flex-wrap gap-2">
                            ${iceOpts.map(o => `<button onclick="updateTemp(${idx}, 'ice', '${o}')" class="option-btn ${data.ice===o?'active-ice':''}">${o}</button>`).join('')}
                        </div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">ç”œåº¦</p>
                        <div class="flex flex-wrap gap-2">
                            ${sugarOpts.map(o => `<button onclick="updateTemp(${idx}, 'sugar', '${o}')" class="option-btn ${data.sugar===o?'active-sugar':''}">${o}</button>`).join('')}
                        </div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">åŠ æ–™</p>
                        <div class="flex flex-wrap gap-2">
                            ${topOpts.map(o => {
                                const active = (data.tops||[]).includes(o);
                                return `<button onclick="toggleTop(${idx}, '${o}')" class="option-btn ${active?'active-top':''}">${o}</button>`;
                            }).join('')}
                        </div>
                        <input type="text" value="${data.customTop||''}" oninput="updateTemp(${idx}, 'customTop', this.value)" class="w-full p-3 bg-white rounded-xl text-xs outline-none border border-stone-100 mt-2" placeholder="è‡ªå¡«å…¶ä»–åŠ æ–™ (éœ€æ±‚ 4)">
                    </div>
                `;
                container.appendChild(section);
            });
        }

        function updateTemp(idx, field, val) {
            state.tempData[idx][field] = val;
            if(['ice', 'sugar'].includes(field)) renderEntries(); // ç‚ºäº†åˆ‡æ›æŒ‰éˆ•ç‹€æ…‹
        }

        function toggleTop(idx, val) {
            let list = state.tempData[idx].tops || [];
            if(list.includes(val)) list = list.filter(v => v !== val);
            else list.push(val);
            state.tempData[idx].tops = list;
            renderEntries();
        }

        // é›²ç«¯å‚™ä»½ (éœ€æ±‚ 5)
        async function saveToCloud() {
            if(!state.user) return showToast("é€£ç·šä¸­...");
            const btn = document.getElementById('btn-save');
            btn.innerText = "åŒæ­¥å‚™ä»½ä¸­..."; btn.disabled = true;
            try {
                const newRecords = { ...state.records, [state.activeKey]: state.tempData };
                const ref = db.collection('artifacts').doc(appId).collection('users').doc(state.user.uid).collection('settings').doc('main');
                await ref.set({ records: newRecords }, { merge: true });
                showToast("âœ¨ å‚™ä»½æˆåŠŸ");
                closeModal();
            } catch (e) { showToast("é€£ç·šç•°å¸¸"); }
            finally { btn.innerText = "ä¿å­˜åˆ°é›²ç«¯"; btn.disabled = false; }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = '1';
            setTimeout(() => { t.style.opacity = '0'; }, 2000);
        }

        // ç•¶ App å¾èƒŒæ™¯å–šé†’ï¼ˆä¸»ç•«é¢é»é–‹ï¼‰æ™‚è‡ªå‹•æ ¡æ­£æ—¥æœŸ
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') syncUI();
        });

        window.onload = async () => {
            syncUI();
            
            // Firebase Auth (ç„¡åç™»å…¥/Token ç™»å…¥)
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
            } catch(e) {}

            auth.onAuthStateChanged(user => {
                state.user = user;
                if(user) {
                    const status = document.getElementById('cloud-status');
                    status.innerHTML = '<i data-lucide="cloud" class="w-3 h-3 text-blue-300"></i> å·²åŒæ­¥';
                    lucide.createIcons();
                    
                    const ref = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('settings').doc('main');
                    ref.onSnapshot(snap => {
                        state.records = snap.exists ? (snap.data().records || {}) : {};
                        renderCalendar();
                        updateStats();
                    }, (err) => console.log(err));
                }
            });
        };
    </script>
</body>
</html>


