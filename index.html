<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è±çš„é£²æ–™æ—¥èªŒ</title>
    
    <!-- PWA å…ƒè³‡æ–™ï¼šç¢ºä¿åœ¨ä¸»ç•«é¢é–‹å•Ÿæ™‚æœ‰æ­£ç¢ºçš„é¡¯ç¤ºæ¨¡å¼ -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="è±çš„é£²èªŒ">
    
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/180/tea-cup.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/180/tea-cup.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --m-pink: #FFD1DC;
            --m-blue: #BAE1FF;
            --m-yellow: #FFF9DB;
            --m-green: #BFFCC6;
            --m-beige: #FDF6F0;
            --text-main: #6D5D4B;
        }
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--m-beige); 
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        .paper-card {
            background: white;
            border-radius: 35px;
            box-shadow: 0 10px 25px -5px rgba(109, 93, 75, 0.05);
            border: 2px solid #FFF;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        .option-btn {
            transition: all 0.2s;
            border-radius: 12px;
            font-weight: 500;
            font-size: 13px;
            padding: 8px 12px;
            border: 1.5px solid #F1E9E2;
            background: white;
            color: #A69B8F;
        }
        .option-btn.active-ice { background: var(--m-blue); border-color: var(--m-blue); color: white; font-weight: 700; }
        .option-btn.active-sugar { background: var(--m-pink); border-color: var(--m-pink); color: white; font-weight: 700; }
        .option-btn.active-top { background: var(--m-green); border-color: var(--m-green); color: #4B6D4B; font-weight: 700; }

        .btn-click { cursor: pointer; transition: transform 0.1s; }
        .btn-click:active { transform: scale(0.95); }
    </style>
</head>
<body class="p-3 md:p-6 min-h-screen">

    <div id="app" class="max-w-md mx-auto space-y-4">
        
        <header class="flex justify-between items-end px-4 py-4 pt-8">
            <div>
                <p id="greeting" class="text-xs font-medium text-stone-400 tracking-widest mb-1">ã“ã‚“ã«ã¡ã¯</p>
                <h1 class="text-2xl font-black tracking-tight">è±çš„é£²æ–™æ—¥èªŒ</h1>
            </div>
            <div id="cloud-status" class="text-[10px] bg-white/50 px-3 py-1 rounded-full border border-white flex items-center gap-1.5 font-bold text-stone-400">
                <i data-lucide="cloud-off" class="w-3 h-3 text-stone-300"></i> Offline
            </div>
        </header>

        <div class="paper-card p-6 space-y-6 relative overflow-hidden">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-pink-50 rounded-full blur-3xl"></div>
            
            <div class="flex justify-between items-center relative z-10">
                <div class="flex items-center gap-3 bg-stone-50 px-4 py-2 rounded-2xl border border-stone-100">
                    <button onclick="changeMonth(-1)" class="btn-click p-1 text-stone-400"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    <!-- åŠ ä¸Šä¸€å€‹é è¨­å­—æ¨£é˜²æ­¢ç©ºå€¼ -->
                    <span id="display-month" class="text-sm font-black min-w-[70px] text-center tracking-tighter">åŠ è¼‰ä¸­...</span>
                    <button onclick="changeMonth(1)" class="btn-click p-1 text-stone-400"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>
                <div class="w-10 h-10 bg-white border border-stone-100 rounded-xl flex items-center justify-center animate-float">
                    <i data-lucide="heart-pulse" class="text-[#FFB7B2] w-5 h-5"></i>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 relative z-10">
                <div>
                    <p class="text-[10px] font-bold text-stone-400 uppercase tracking-widest mb-1">æœ¬æœˆèŠ±è²»</p>
                    <h2 class="text-3xl font-black text-stone-700 leading-none">$<span id="stat-price">0</span></h2>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-bold text-stone-400 uppercase tracking-widest mb-1">ç´€éŒ„æ¯æ•¸</p>
                    <h2 class="text-3xl font-black text-stone-700 leading-none"><span id="stat-cups">0</span> <span class="text-sm font-medium">æ¯</span></h2>
                </div>
            </div>

            <div class="pt-2">
                <div class="flex justify-between text-[10px] font-bold text-stone-400 mb-1.5">
                    <span class="flex items-center gap-1"><i data-lucide="sparkles" class="w-3 h-3"></i> æœ¬æœˆå¥åº·æŒ‡æ•¸</span>
                    <span id="health-score-text">100%</span>
                </div>
                <div class="w-full h-3 bg-stone-100 rounded-full overflow-hidden border border-white">
                    <div id="health-progress" class="h-full bg-gradient-to-r from-[#BFFCC6] to-[#BAE1FF] transition-all duration-1000 shadow-inner" style="width: 100%"></div>
                </div>
                <p id="health-tip" class="text-[9px] text-stone-400 mt-2 font-medium italic text-center">æ­£åœ¨åŒæ­¥ç´€éŒ„...</p>
            </div>
        </div>

        <div onclick="pickRandom()" class="btn-click paper-card p-4 flex items-center justify-between bg-gradient-to-r from-white to-[#FFF9DB]/30 border-dashed border-2 border-[#FFF9DB]">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-[#FFF9DB] rounded-2xl flex items-center justify-center shadow-sm">
                    <i data-lucide="shuffle" class="text-[#D4A373] w-6 h-6"></i>
                </div>
                <div>
                    <h4 class="text-sm font-black">ä»Šæ—¥é£²å“éˆæ„Ÿ</h4>
                    <p class="text-[11px] text-stone-400">ç¿»ç¿»èˆŠå›æ†¶ï¼Œé¸å€‹å¥½å‘³é“</p>
                </div>
            </div>
            <i data-lucide="arrow-right" class="w-4 h-4 text-stone-300"></i>
        </div>

        <div class="paper-card p-6">
            <div class="grid grid-cols-7 text-center text-[10px] font-black text-stone-300 uppercase tracking-tighter mb-4">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-2.5"></div>
        </div>

        <div class="grid grid-cols-2 gap-3 pb-12">
            <div class="paper-card p-5">
                <p class="text-[10px] font-bold text-stone-400 uppercase mb-2 flex items-center gap-1"><i data-lucide="star" class="w-3 h-3 text-yellow-300"></i> æœ€æ„›å“é …</p>
                <p id="top-item" class="text-sm font-black truncate text-stone-600">å°šæœªç´€éŒ„</p>
            </div>
            <div class="paper-card p-5">
                <p class="text-[10px] font-bold text-stone-400 uppercase mb-2 flex items-center gap-1"><i data-lucide="map-pin" class="w-3 h-3 text-blue-300"></i> æœ€å¸¸é€ è¨ª</p>
                <p id="top-shop" class="text-sm font-black truncate text-stone-600">å°šæœªç´€éŒ„</p>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-stone-800/20 backdrop-blur-sm hidden z-50 items-end justify-center transition-all">
        <div class="bg-white w-full max-w-md rounded-t-[45px] shadow-2xl p-6 space-y-6 max-h-[90vh] overflow-y-auto no-scrollbar border-t-4 border-white">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="w-2 h-6 bg-pink-200 rounded-full"></span>
                    <h3 id="modal-date-title" class="text-lg font-black text-stone-700">ç´€éŒ„</h3>
                </div>
                <button onclick="closeModal()" class="w-10 h-10 flex items-center justify-center bg-stone-50 rounded-full text-stone-400">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="entries-container" class="space-y-8"></div>
            <button id="btn-save" onclick="saveToCloud()" class="btn-click w-full bg-[#6D5D4B] text-white py-4 rounded-3xl font-black text-lg shadow-xl shadow-stone-200">
                ä¿å­˜ç´€éŒ„
            </button>
            <div class="h-6"></div>
        </div>
    </div>

    <div id="toast" class="fixed top-10 left-1/2 -translate-x-1/2 bg-stone-800 text-white px-6 py-3 rounded-full text-xs font-bold shadow-2xl z-[100] opacity-0 pointer-events-none transition-all duration-300"></div>

    <script>
        const firebaseConfig = JSON.parse(__firebase_config);
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'xuan-drink-diary-v4';

        const iceOpts = ['å›ºå®š', 'æ­£å¸¸', 'å°‘å†°', 'å¾®å†°', 'å»å†°', 'å¸¸æº«', 'ç†±çš„'];
        const sugarOpts = ['å›ºå®š', 'æ­£å¸¸', 'å°‘ç³–', 'åŠç³–', 'å¾®ç³–', 'ä¸€åˆ†', 'ç„¡ç³–'];
        const topOpts = ['çç ', 'æ³¢éœ¸', 'æ¤°æœ', 'èŠ‹åœ“', 'ä»™è‰', 'å¸ƒä¸'];

        let state = {
            user: null,
            viewDate: new Date(), // åˆå§‹æ™‚é–“
            records: {},
            activeKey: null,
            tempData: [{}, {}]
        };

        // å¼·åˆ¶æ ¡æº–æ™‚é–“å‡½æ•¸
        function syncClock() {
            const now = new Date();
            // å¦‚æœ state.viewDate å°šæœªè¢«åˆå§‹åŒ–ï¼Œå‰‡å¼·åˆ¶è¨­ç‚ºç•¶å‰
            if (!state.viewDate || isNaN(state.viewDate.getTime())) {
                state.viewDate = now;
            }
            renderCalendar();
            updateStats();
            setGreeting();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = '1'; t.style.top = '20px';
            setTimeout(() => { t.style.opacity = '0'; t.style.top = '10px'; }, 2500);
        }

        function setGreeting() {
            const hr = new Date().getHours();
            const g = hr < 12 ? "ãŠã¯ã‚ˆã† (æ—©å®‰)" : hr < 18 ? "ã“ã‚“ã«ã¡ã¯ (åˆå®‰)" : "ã“ã‚“ã°ã‚“ã¯ (æ™šå®‰)";
            const greetingEl = document.getElementById('greeting');
            if (greetingEl) greetingEl.innerText = g;
        }

        function changeMonth(step) {
            state.viewDate.setMonth(state.viewDate.getMonth() + step);
            renderCalendar();
            updateStats();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            const display = document.getElementById('display-month');
            if (!display || !grid) return;

            const y = state.viewDate.getFullYear(), m = state.viewDate.getMonth();
            display.innerText = `${y} / ${String(m+1).padStart(2,'0')}`;
            
            grid.innerHTML = '';
            const first = new Date(y, m, 1).getDay();
            const days = new Date(y, m+1, 0).getDate();
            
            for(let i=0; i<first; i++) grid.appendChild(document.createElement('div'));
            
            for(let d=1; d<=days; d++) {
                const key = `${y}-${m+1}-${d}`;
                const drinks = (state.records[key] || []).filter(r => r && r.item);
                const hasData = drinks.length > 0;
                const btn = document.createElement('button');
                btn.onclick = () => openModal(key);
                btn.className = `aspect-square rounded-2xl flex flex-col items-center justify-center transition-all btn-click ${hasData ? 'bg-[#FFD1DC]/20 text-[#D87093] font-black' : 'text-stone-300 hover:bg-stone-50'}`;
                btn.innerHTML = `<span class="text-xs">${d}</span>`;
                if(hasData) {
                    btn.innerHTML += `<div class="flex gap-0.5 mt-0.5">${Array(drinks.length).fill('<div class="w-1 h-1 rounded-full bg-[#FFD1DC]"></div>').join('')}</div>`;
                }
                grid.appendChild(btn);
            }
        }

        function updateStats() {
            const y = state.viewDate.getFullYear(), m = state.viewDate.getMonth() + 1;
            let price = 0, cups = 0, itemsMap = {}, shopsMap = {}, penaltyScore = 0;
            
            Object.keys(state.records).forEach(key => {
                if(key.startsWith(`${y}-${m}-`)) {
                    (state.records[key] || []).forEach(r => {
                        if(r && r.item) {
                            price += Number(r.price || 0);
                            cups++;
                            itemsMap[r.item] = (itemsMap[r.item] || 0) + 1;
                            if(r.shop) shopsMap[r.shop] = (shopsMap[r.shop] || 0) + 1;
                            if(['æ­£å¸¸', 'å›ºå®š', 'å°‘ç³–'].includes(r.sugar)) penaltyScore += 25;
                            else if(r.sugar === 'åŠç³–') penaltyScore += 15;
                            else if(['å¾®ç³–', 'ä¸€åˆ†'].includes(r.sugar)) penaltyScore += 5;
                        }
                    });
                }
            });

            const pEl = document.getElementById('stat-price');
            const cEl = document.getElementById('stat-cups');
            if (pEl) pEl.innerText = price;
            if (cEl) cEl.innerText = cups;
            
            const topItem = Object.entries(itemsMap).sort((a,b)=>b[1]-a[1])[0];
            const topShop = Object.entries(shopsMap).sort((a,b)=>b[1]-a[1])[0];
            const tiEl = document.getElementById('top-item');
            const tsEl = document.getElementById('top-shop');
            if (tiEl) tiEl.innerText = topItem ? topItem[0] : 'å°šæœªç´€éŒ„';
            if (tsEl) tsEl.innerText = topShop ? topShop[0] : 'å°šæœªç´€éŒ„';

            let healthScore = Math.max(0, 100 - penaltyScore);
            const progressEl = document.getElementById('health-progress');
            const scoreTextEl = document.getElementById('health-score-text');
            const tipEl = document.getElementById('health-tip');

            if (scoreTextEl) scoreTextEl.innerText = healthScore + '%';
            if (progressEl) progressEl.style.width = healthScore + '%';

            if(healthScore > 70) {
                if (progressEl) progressEl.style.background = 'linear-gradient(to right, #BFFCC6, #BAE1FF)';
                if (tipEl) tipEl.innerText = cups === 0 ? "é€™å€‹æœˆé‚„æ²’å–é£²æ–™ï¼Œå¥åº·æ»¿åˆ†ä¸­ï¼âœ¨" : "è±ç›®å‰çš„ç‹€æ…‹éå¸¸å¥åº·å–”ï¼Œç¹¼çºŒä¿æŒï¼ğŸµ";
            } else if (healthScore > 40) {
                if (progressEl) progressEl.style.background = 'linear-gradient(to right, #FFF9DB, #FFD1DC)';
                if (tipEl) tipEl.innerText = "é€™å€‹æœˆçš„é£²æ–™é¡åº¦å¿«åˆ°å›‰ï¼Œå¤šå–é»æ°´å§ï¼ğŸ’§";
            } else {
                if (progressEl) progressEl.style.background = 'linear-gradient(to right, #FFD1DC, #FFB2C5)';
                if (tipEl) tipEl.innerText = "å¥åº·è­¦å‘Šï¼é€™å€‹æœˆç³–åˆ†æ”å–å¤ªå¤šå•¦ï¼Œæ§åˆ¶ä¸€ä¸‹ï¼ğŸš«";
            }
        }

        function openModal(key) {
            state.activeKey = key;
            const parts = key.split('-');
            const titleEl = document.getElementById('modal-date-title');
            if (titleEl) titleEl.innerText = `${parts[1]}æœˆ${parts[2]}æ—¥ é£²å“ç´€éŒ„`;
            state.tempData = JSON.parse(JSON.stringify(state.records[key] || [{}, {}]));
            renderEntries();
            document.getElementById('modal-overlay').classList.replace('hidden', 'flex');
            lucide.createIcons();
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.replace('flex', 'hidden');
        }

        function renderEntries() {
            const container = document.getElementById('entries-container');
            if (!container) return;
            container.innerHTML = '';
            state.tempData.forEach((data, idx) => {
                const section = document.createElement('div');
                section.className = "space-y-4 bg-stone-50/50 p-4 rounded-3xl border border-stone-100";
                section.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-[10px] font-black tracking-widest text-stone-300 uppercase">ç¬¬ ${idx+1} æ¯</span>
                        <div class="flex items-center gap-1 bg-white px-3 py-1 rounded-full border border-stone-100">
                            <span class="text-[10px] font-bold text-stone-400">$</span>
                            <input type="number" value="${data.price||''}" oninput="updateTemp(${idx}, 'price', this.value)" class="w-12 bg-transparent text-sm font-black outline-none" placeholder="0">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" value="${data.shop||''}" oninput="updateTemp(${idx}, 'shop', this.value)" class="w-full p-4 bg-white rounded-2xl text-sm border-none outline-none shadow-sm" placeholder="åº—å®¶åç¨±">
                        <input type="text" value="${data.item||''}" oninput="updateTemp(${idx}, 'item', this.value)" class="w-full p-4 bg-white rounded-2xl text-sm border-none outline-none shadow-sm" placeholder="é£²å“åç¨±">
                    </div>
                    <div class="space-y-2">
                        <p class="text-[10px] font-bold text-stone-400">å†°å¡Š</p>
                        <div class="flex flex-wrap gap-2">
                            ${iceOpts.map(o => `<button onclick="updateTemp(${idx}, 'ice', '${o}')" class="option-btn ${data.ice===o?'active-ice':''}">${o}</button>`).join('')}
                        </div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-[10px] font-bold text-stone-400">ç”œåº¦</p>
                        <div class="flex flex-wrap gap-2">
                            ${sugarOpts.map(o => `<button onclick="updateTemp(${idx}, 'sugar', '${o}')" class="option-btn ${data.sugar===o?'active-sugar':''}">${o}</button>`).join('')}
                        </div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-[10px] font-bold text-stone-400">åŠ æ–™</p>
                        <div class="flex flex-wrap gap-2">
                            ${topOpts.map(o => {
                                const active = (data.tops||[]).includes(o);
                                return `<button onclick="toggleTop(${idx}, '${o}')" class="option-btn ${active?'active-top':''}">${o}</button>`;
                            }).join('')}
                        </div>
                        <input type="text" value="${data.customTop||''}" oninput="updateTemp(${idx}, 'customTop', this.value)" class="w-full p-3 bg-white rounded-xl text-xs outline-none border border-stone-100 mt-1" placeholder="è‡ªå¡«å…¶ä»–åŠ æ–™...">
                    </div>
                `;
                container.appendChild(section);
            });
        }

        function updateTemp(idx, field, val) {
            state.tempData[idx][field] = val;
            if(['ice', 'sugar'].includes(field)) renderEntries();
        }

        function toggleTop(idx, val) {
            let list = state.tempData[idx].tops || [];
            if(list.includes(val)) list = list.filter(v => v !== val);
            else list.push(val);
            state.tempData[idx].tops = list;
            renderEntries();
        }

        async function saveToCloud() {
            if(!state.user) return showToast("é€£ç·šä¸­...");
            const btn = document.getElementById('btn-save');
            btn.innerText = "åŒæ­¥ç´€éŒ„ä¸­..."; btn.disabled = true;
            try {
                const newRecords = { ...state.records, [state.activeKey]: state.tempData };
                const ref = db.collection('artifacts').doc(appId).collection('users').doc(state.user.uid).collection('settings').doc('main');
                await ref.set({ records: newRecords }, { merge: true });
                showToast("âœ¨ ç´€éŒ„å·²æ”¶è—");
                closeModal();
            } catch (e) { showToast("åŒæ­¥å¤±æ•—"); }
            finally { btn.innerText = "ä¿å­˜ç´€éŒ„"; btn.disabled = false; }
        }

        function pickRandom() {
            const all = [];
            Object.values(state.records).forEach(day => {
                if(Array.isArray(day)) day.forEach(r => { if(r && r.item) all.push(r.item); });
            });
            const unique = [...new Set(all)];
            if(unique.length === 0) return showToast("é‚„æ²’ç´€éŒ„éé£²æ–™å”·ï¼");
            const pick = unique[Math.floor(Math.random()*unique.length)];
            showToast(`âœ¨ ä»Šæ—¥æ¨è–¦ï¼š${pick}`);
        }

        // ç•¶ App å¾èƒŒæ™¯æ¢å¾©æ™‚ï¼Œé‡æ–°åŒæ­¥æ™‚é–“ï¼ˆè§£æ±ºä¸»ç•«é¢é–‹å•Ÿå¾Œçš„æ—¥æœŸå•é¡Œï¼‰
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                syncClock();
            }
        });

        window.onload = async () => {
            // åˆå§‹åŒ–æ™‚é–“
            syncClock();
            
            // æ¯åˆ†é˜è‡ªå‹•æª¢æŸ¥ä¸€æ¬¡ï¼ˆå¿ƒè·³æ©Ÿåˆ¶ï¼‰
            setInterval(syncClock, 60000);

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
            } catch(e) {}

            auth.onAuthStateChanged(user => {
                state.user = user;
                if(user) {
                    const statusEl = document.getElementById('cloud-status');
                    if (statusEl) statusEl.innerHTML = '<i data-lucide="cloud" class="w-3 h-3 text-blue-300"></i> Cloud Synced';
                    lucide.createIcons();
                    const ref = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('settings').doc('main');
                    ref.onSnapshot(snap => {
                        state.records = snap.exists ? (snap.data().records || {}) : {};
                        renderCalendar();
                        updateStats();
                    });
                }
            });
        };
    </script>
</body>
</html>

