<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>萱の飲料日誌</title>
    
    <!-- PWA 配置 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="萱の日誌">
    <link rel="apple-touch-icon" href="https://img.icons8.com/plasticine/200/tea-cup.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --m-pink: #FFDDE2;
            --m-blue: #D6EFFF;
            --m-yellow: #FFF9E3;
            --m-green: #E2F5D6;
            --bg-soft: #FDFBFA;
            --text-dark: #5A524D;
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-soft); 
            color: var(--text-dark);
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 40px;
        }

        .serif-title { font-family: 'Noto Serif TC', serif; }

        .health-gradient {
            background: linear-gradient(90deg, #A8E6CF 0%, #FFD3B6 50%, #FFAAA5 100%);
            transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .paper-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 35px;
            box-shadow: 0 15px 35px -10px rgba(90, 82, 77, 0.08);
            border: 1px solid rgba(255, 255, 255, 1);
        }

        .option-btn {
            transition: all 0.2s;
            border-radius: 14px;
            font-size: 13px;
            padding: 9px 15px;
            border: 1.5px solid #F5F0EB;
            background: #FFFFFF;
            color: #B2A69B;
            font-weight: 500;
        }

        .option-btn.active-ice { background: var(--m-blue); border-color: #B9DFFF; color: #5D7A8C; font-weight: 700; transform: scale(1.05); }
        .option-btn.active-sugar { background: var(--m-pink); border-color: #FFC9D2; color: #8C5D66; font-weight: 700; transform: scale(1.05); }
        .option-btn.active-top { background: var(--m-green); border-color: #CCE6BC; color: #5D8C62; font-weight: 700; }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            position: relative;
            transition: all 0.2s;
        }

        .has-record { background: #5A524D !important; color: #FFFFFF !important; font-weight: 900; }
        .is-today { border: 2px solid #5A524D; color: #5A524D; font-weight: 900; }
        .dot { width: 4px; height: 4px; border-radius: 50%; background: #FFB7C5; position: absolute; bottom: 6px; }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .modal-animate { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="p-5">

    <div id="app" class="max-w-md mx-auto space-y-6">
        <header class="flex justify-between items-end px-2 pt-8">
            <div>
                <p id="greeting" class="text-[10px] font-black text-stone-300 tracking-[0.3em] mb-1 uppercase">Have a sweet day</p>
                <h1 class="text-3xl font-black serif-title text-stone-700">萱の飲料日誌</h1>
            </div>
            <div id="sync-status" class="flex items-center gap-1.5 bg-white px-3 py-1.5 rounded-full border border-stone-100 shadow-sm">
                <div id="sync-dot" class="w-2 h-2 rounded-full bg-stone-300 animate-pulse"></div>
                <span id="sync-text" class="text-[9px] font-bold text-stone-400">連線中</span>
            </div>
        </header>

        <div class="paper-card p-7 space-y-7">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3 bg-stone-100/60 px-4 py-2 rounded-2xl">
                    <button onclick="changeMonth(-1)"><i data-lucide="chevron-left" class="w-4 h-4 text-stone-400"></i></button>
                    <span id="display-month" class="text-sm font-black text-stone-600 min-w-[85px] text-center tracking-tighter">---- / --</span>
                    <button onclick="changeMonth(1)"><i data-lucide="chevron-right" class="w-4 h-4 text-stone-400"></i></button>
                </div>
                <div class="w-10 h-10 bg-[var(--m-yellow)] rounded-full flex items-center justify-center shadow-inner">
                    <i data-lucide="sparkles" class="text-amber-400 w-5 h-5"></i>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <p class="text-[10px] font-bold text-stone-300 uppercase tracking-widest">本月花費總額</p>
                    <h2 class="text-4xl font-black text-stone-700 leading-none tracking-tighter">$<span id="stat-price">0</span></h2>
                </div>
                <div class="text-right space-y-1">
                    <p class="text-[10px] font-bold text-stone-300 uppercase tracking-widest">本月杯數</p>
                    <h2 class="text-4xl font-black text-stone-700 leading-none tracking-tighter"><span id="stat-cups">0</span> <span class="text-xs font-medium">杯</span></h2>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-[11px] font-bold text-stone-500 flex items-center gap-2">
                        <i data-lucide="activity" class="w-3.5 h-3.5 text-rose-300"></i> 健康平衡指數
                    </span>
                    <span id="health-score-text" class="text-xs font-black text-stone-400">100%</span>
                </div>
                <div class="w-full h-3 bg-stone-100/80 rounded-full overflow-hidden border border-white p-[2px]">
                    <div id="health-progress" class="h-full rounded-full health-gradient" style="width: 100%"></div>
                </div>
                <p id="health-tip" class="text-[10px] text-stone-400 italic text-center">今天也要記得多喝白開水唷，萱 ✨</p>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="paper-card p-5 space-y-2 border-b-4 border-b-[var(--m-blue)]">
                <p class="text-[9px] font-black text-stone-300 tracking-widest uppercase">Favorite Shop</p>
                <p id="top-shop" class="text-sm font-black text-stone-600 truncate">尚未紀錄</p>
            </div>
            <div class="paper-card p-5 space-y-2 border-b-4 border-b-[var(--m-pink)]">
                <p class="text-[9px] font-black text-stone-300 tracking-widest uppercase">Top Drink</p>
                <p id="top-item" class="text-sm font-black text-stone-600 truncate">尚未紀錄</p>
            </div>
        </div>

        <div class="paper-card p-6">
            <div class="grid grid-cols-7 text-center text-[10px] font-black text-stone-300 uppercase tracking-[0.2em] mb-5">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-3"></div>
        </div>

        <div class="h-10"></div>
    </div>

    <!-- 編輯彈窗 -->
    <div id="modal-overlay" class="fixed inset-0 bg-stone-900/40 backdrop-blur-md hidden z-50 items-end justify-center">
        <div class="bg-white w-full max-w-md rounded-t-[45px] p-8 space-y-6 max-h-[90vh] overflow-y-auto no-scrollbar modal-animate shadow-2xl">
            <div class="flex justify-between items-center pb-2">
                <div>
                    <h3 id="modal-date-title" class="text-2xl font-black serif-title text-stone-700">飲品日記</h3>
                    <p class="text-[10px] text-stone-300 font-bold tracking-widest uppercase mt-1">Record your sweetness</p>
                </div>
                <button onclick="closeModal()" class="w-12 h-12 flex items-center justify-center bg-stone-50 rounded-full text-stone-400 shadow-sm active:scale-90 transition-transform">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="entries-container" class="space-y-8"></div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeModal()" class="w-full bg-stone-100 text-stone-400 py-4.5 rounded-[25px] font-black text-lg active:scale-[0.98] transition-all">
                    取消
                </button>
                <button onclick="saveData()" class="w-full bg-[#5A524D] text-white py-4.5 rounded-[25px] font-black text-lg shadow-xl shadow-stone-200 active:scale-[0.98] transition-all">
                    保存
                </button>
            </div>
            <div class="h-10"></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-12 left-1/2 -translate-x-1/2 bg-stone-800/90 text-white px-8 py-3.5 rounded-full text-[11px] font-bold shadow-2xl z-[100] opacity-0 pointer-events-none transition-all duration-500"></div>

    <script>
        const iceOpts = ['固定', '正常', '少冰', '微冰', '去冰', '常溫', '熱的'];
        const sugarOpts = ['固定', '正常', '少糖', '半糖', '微糖', '一分', '無糖'];
        const topOpts = ['珍珠', '波霸', '椰果', '芋圓', '仙草', '布丁'];

        let state = {
            viewDate: new Date(),
            records: JSON.parse(localStorage.getItem('xuan_v10_records') || '{}'),
            activeKey: null,
            tempData: [{}, {}],
            user: null
        };

        try {
            const config = JSON.parse(__firebase_config);
            firebase.initializeApp(config);
            const db = firebase.firestore();
            const auth = firebase.auth();
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'xuan-diary-v10';

            auth.onAuthStateChanged(user => {
                if(user) {
                    state.user = user;
                    updateSyncUI('cloud', '連線成功');
                    db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('settings').doc('main')
                    .onSnapshot(snap => {
                        if(snap.exists) {
                            state.records = { ...state.records, ...snap.data().records };
                            saveLocal();
                            renderCalendar();
                            updateStats();
                        }
                    });
                } else {
                    auth.signInAnonymously().catch(() => updateSyncUI('offline', '本地模式'));
                }
            });
        } catch(e) { updateSyncUI('offline', '本地模式'); }

        function updateSyncUI(mode, text) {
            const dot = document.getElementById('sync-dot');
            const txt = document.getElementById('sync-text');
            if(txt) txt.innerText = text;
            if(dot) dot.className = `w-2 h-2 rounded-full ${mode === 'cloud' ? 'bg-green-400' : 'bg-amber-300'}`;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            if(!grid) return;
            grid.innerHTML = '';
            const y = state.viewDate.getFullYear(), m = state.viewDate.getMonth();
            const days = new Date(y, m+1, 0).getDate();
            const first = new Date(y, m, 1).getDay();
            const today = new Date();
            document.getElementById('display-month').innerText = `${y} / ${String(m+1).padStart(2,'0')}`;
            for(let i=0; i<first; i++) grid.appendChild(document.createElement('div'));
            for(let d=1; d<=days; d++) {
                const key = `${y}-${m+1}-${d}`;
                const hasData = (state.records[key] || []).some(r => r.item);
                const isToday = today.getFullYear()===y && today.getMonth()===m && today.getDate()===d;
                const btn = document.createElement('button');
                btn.className = `calendar-day hover:scale-110 active:scale-95 ${hasData ? 'has-record' : isToday ? 'is-today' : 'text-stone-300 bg-white/50'}`;
                btn.innerHTML = `<span>${d}</span>${hasData ? '<div class="dot"></div>' : ''}`;
                btn.onclick = () => openModal(key);
                grid.appendChild(btn);
            }
            updateStats();
        }

        function openModal(key) {
            state.activeKey = key;
            state.tempData = JSON.parse(JSON.stringify(state.records[key] || [{}, {}]));
            const p = key.split('-');
            document.getElementById('modal-date-title').innerText = `${p[1]}月${p[2]}日`;
            renderEntries();
            document.getElementById('modal-overlay').classList.replace('hidden', 'flex');
            lucide.createIcons();
        }

        function renderEntries() {
            const container = document.getElementById('entries-container');
            container.innerHTML = '';
            state.tempData.forEach((data, idx) => {
                const div = document.createElement('div');
                div.className = "bg-stone-50/80 p-6 rounded-[35px] space-y-5 border border-white relative";
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-black text-stone-300 tracking-widest uppercase">Drink ${idx+1}</span>
                        <div class="flex items-center gap-3">
                            <button onclick="clearEntry(${idx})" class="p-2 text-rose-200 hover:text-rose-400 active:scale-90 transition-all">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                            <div class="bg-white px-4 py-2 rounded-2xl border border-stone-100 flex items-center gap-2 shadow-sm">
                                <span class="text-[11px] font-bold text-stone-400">$</span>
                                <input type="number" value="${data.price||''}" oninput="updateTemp(${idx},'price',this.value)" class="w-12 text-sm font-black text-stone-600 outline-none bg-transparent" placeholder="0">
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" value="${data.shop||''}" oninput="updateTemp(${idx},'shop',this.value)" class="p-4 bg-white rounded-2xl text-xs outline-none border border-stone-100 shadow-inner" placeholder="店家">
                        <input type="text" value="${data.item||''}" oninput="updateTemp(${idx},'item',this.value)" class="p-4 bg-white rounded-2xl text-xs outline-none border border-stone-100 shadow-inner" placeholder="飲料名稱">
                    </div>
                    <div class="space-y-2">
                        <p class="text-[9px] font-bold text-stone-300 ml-1">ICE LEVEL</p>
                        <div class="flex flex-wrap gap-2">${iceOpts.map(o => `<button onclick="updateTemp(${idx},'ice','${o}')" class="option-btn ${data.ice===o?'active-ice':''}">${o}</button>`).join('')}</div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-[9px] font-bold text-stone-300 ml-1">SUGAR LEVEL</p>
                        <div class="flex flex-wrap gap-2">${sugarOpts.map(o => `<button onclick="updateTemp(${idx},'sugar','${o}')" class="option-btn ${data.sugar===o?'active-sugar':''}">${o}</button>`).join('')}</div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-[9px] font-bold text-stone-300 ml-1">TOPPINGS</p>
                        <div class="flex flex-wrap gap-2">${topOpts.map(o => `<button onclick="toggleTop(${idx},'${o}')" class="option-btn ${(data.tops||[]).includes(o)?'active-top':''}">${o}</button>`).join('')}</div>
                        <input type="text" value="${data.customTop||''}" oninput="updateTemp(${idx},'customTop',this.value)" class="w-full p-4 bg-white rounded-2xl text-[11px] outline-none border border-stone-100 mt-2 shadow-inner" placeholder="自填其他加料...">
                    </div>
                `;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function clearEntry(idx) {
            state.tempData[idx] = {};
            renderEntries();
            showToast("已清空該欄位");
        }

        function updateTemp(idx, f, v) { 
            state.tempData[idx][f] = v; 
            if(['ice','sugar'].includes(f)) renderEntries(); 
        }
        
        function toggleTop(idx, v) { 
            let t = state.tempData[idx].tops || []; 
            state.tempData[idx].tops = t.includes(v) ? t.filter(x=>x!==v) : [...t, v]; 
            renderEntries(); 
        }

        function saveData() {
            state.records[state.activeKey] = state.tempData;
            saveLocal();
            renderCalendar();
            closeModal();
            showToast("✨ 紀錄已保存");
            if(state.user) {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'xuan-diary-v10';
                firebase.firestore().collection('artifacts').doc(appId).collection('users').doc(state.user.uid).collection('settings').doc('main')
                .set({ records: state.records }, { merge: true });
            }
        }

        function saveLocal() { localStorage.setItem('xuan_v10_records', JSON.stringify(state.records)); }
        function closeModal() { document.getElementById('modal-overlay').classList.replace('flex', 'hidden'); }
        function changeMonth(s) { state.viewDate.setMonth(state.viewDate.getMonth() + s); renderCalendar(); }

        function updateStats() {
            const y = state.viewDate.getFullYear(), m = state.viewDate.getMonth() + 1;
            let price = 0, cups = 0, penalty = 0, shops = {}, items = {};
            Object.keys(state.records).forEach(k => {
                if(k.startsWith(`${y}-${m}-`)) {
                    (state.records[k] || []).forEach(r => {
                        if(r.item) {
                            price += Number(r.price||0); cups++;
                            shops[r.shop] = (shops[r.shop]||0)+1; items[r.item] = (items[r.item]||0)+1;
                            if(['正常','固定','少糖'].includes(r.sugar)) penalty += 20;
                            else if(r.sugar === '半糖') penalty += 10;
                            else if(r.sugar === '微糖') penalty += 5;
                        }
                    });
                }
            });
            document.getElementById('stat-price').innerText = price;
            document.getElementById('stat-cups').innerText = cups;
            const score = Math.max(0, 100 - penalty);
            document.getElementById('health-score-text').innerText = score + '%';
            document.getElementById('health-progress').style.width = score + '%';
            document.getElementById('top-shop').innerText = Object.entries(shops).sort((a,b)=>b[1]-a[1])[0]?.[0] || '尚未紀錄';
            document.getElementById('top-item').innerText = Object.entries(items).sort((a,b)=>b[1]-a[1])[0]?.[0] || '尚未紀錄';
        }

        function showToast(m) {
            const t = document.getElementById('toast');
            if(!t) return;
            t.innerText = m; t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 2500);
        }

        window.onload = () => {
            const hr = new Date().getHours();
            const g = document.getElementById('greeting');
            if(g) g.innerText = hr < 11 ? "Good Morning, Xuan" : hr < 17 ? "Good Afternoon, Xuan" : "Good Evening, Xuan";
            renderCalendar();
            lucide.createIcons();
        };
    </script>
</body>
</html>


