<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è±ã®é£²æ–™æ—¥èªŒ</title>
    
    <!-- PWA é…ç½® -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="è±ã®æ—¥èªŒ">
    
    <!-- æ—¥ç³»æ–‡é’åœ–ç¤ºï¼šä½¿ç”¨æ‰‹ç¹ªæ„ŸèŒ¶æ¯ -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/plasticine/200/tea-cup.png">
    <link rel="icon" type="image/png" href="https://img.icons8.com/plasticine/200/tea-cup.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --m-pink: #FFD1DC;
            --m-blue: #BAE1FF;
            --m-yellow: #FFF9DB;
            --m-green: #BFFCC6;
            --m-purple: #DCD3FF;
            --m-beige: #F9F7F2; 
            --text-main: #5D544B;
        }
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--m-beige); 
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent; 
            padding-bottom: env(safe-area-inset-bottom);
        }
        .serif-title { font-family: 'Noto Serif TC', serif; }
        
        .paper-card {
            background: white;
            border-radius: 32px;
            box-shadow: 0 10px 30px -10px rgba(93, 84, 75, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.8);
            overflow: hidden;
        }

        /* é¦¬å¡é¾è‰²ç³»é¸é … */
        .option-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 14px;
            font-size: 13px;
            padding: 10px 14px;
            border: 1.5px solid #F2EEE9;
            background: #FDFDFD;
            color: #A39689;
        }
        .option-btn.active-ice { background: var(--m-blue); border-color: var(--m-blue); color: #4A6070; font-weight: 700; transform: translateY(-2px); }
        .option-btn.active-sugar { background: var(--m-pink); border-color: var(--m-pink); color: #704A55; font-weight: 700; transform: translateY(-2px); }
        .option-btn.active-top { background: var(--m-green); border-color: var(--m-green); color: #4A704D; font-weight: 700; }

        .btn-click { cursor: pointer; transition: transform 0.1s; }
        .btn-click:active { transform: scale(0.95); }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            position: relative;
        }
        .dot { width: 4px; height: 4px; border-radius: 50%; background: var(--m-pink); position: absolute; bottom: 6px; }
        
        /* æ»¾å‹•æ¢éš±è— */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ç‰¹æ®Šçµ±è¨ˆå¡ç‰‡æ¨£å¼ */
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
            border: 1px solid rgba(255, 255, 255, 1);
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="app" class="max-w-md mx-auto space-y-6">
        
        <!-- é ‚éƒ¨è³‡è¨Šèˆ‡åŒæ­¥æŒ‰éˆ• -->
        <header class="flex justify-between items-end px-2 pt-6">
            <div>
                <p id="greeting" class="text-[10px] font-bold text-stone-400 tracking-[0.25em] mb-1 uppercase">Loading...</p>
                <h1 class="text-3xl font-black serif-title tracking-tight text-stone-700">è±ã®é£²æ–™æ—¥èªŒ</h1>
            </div>
            <button onclick="forceSync()" id="sync-btn" class="bg-white/80 backdrop-blur px-3 py-1.5 rounded-full border border-stone-100 flex items-center gap-1.5 font-bold text-[10px] text-stone-400 shadow-sm btn-click">
                <i data-lucide="refresh-cw" id="sync-icon" class="w-3 h-3"></i> <span id="sync-text">å·²é€£ç·š</span>
            </button>
        </header>

        <!-- ä¸»ç•«é¢çœ‹æ¿ï¼šç¸½èŠ±è²»ã€ç¸½æ¯æ•¸ã€å¥åº·æŒ‡æ•¸ (éœ€æ±‚ 7) -->
        <div class="paper-card p-6 space-y-7">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2 bg-stone-100/60 px-4 py-2 rounded-2xl">
                    <button onclick="changeMonth(-1)" class="btn-click text-stone-400"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                    <span id="display-month" class="text-sm font-black tracking-tight min-w-[85px] text-center text-stone-600">---- / --</span>
                    <button onclick="changeMonth(1)" class="btn-click text-stone-400"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                </div>
                <div class="w-10 h-10 bg-[var(--m-yellow)] rounded-full flex items-center justify-center shadow-inner">
                    <i data-lucide="coffee" class="text-[#D4A373] w-5 h-5"></i>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-6">
                <div class="space-y-1">
                    <p class="text-[10px] font-bold text-stone-300 uppercase tracking-widest">ç›®å‰èŠ±è²»ç¸½é¡</p>
                    <h2 class="text-4xl font-black text-stone-700 leading-none tracking-tighter">$<span id="stat-price">0</span></h2>
                </div>
                <div class="text-right space-y-1">
                    <p class="text-[10px] font-bold text-stone-300 uppercase tracking-widest">ç¸½æ¯æ•¸</p>
                    <h2 class="text-4xl font-black text-stone-700 leading-none tracking-tighter"><span id="stat-cups">0</span> <span class="text-xs font-medium text-stone-400">CUPS</span></h2>
                </div>
            </div>

            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-[11px] font-bold text-stone-500 flex items-center gap-1.5">
                        <i data-lucide="heart" class="w-3.5 h-3.5 text-pink-300"></i> å¥åº·æŒ‡æ•¸
                    </span>
                    <span id="health-score-text" class="text-xs font-black text-stone-400">100%</span>
                </div>
                <div class="w-full h-2.5 bg-stone-100 rounded-full overflow-hidden border border-white">
                    <div id="health-progress" class="h-full bg-gradient-to-r from-green-200 via-blue-200 to-pink-200 transition-all duration-1000 shadow-inner" style="width: 100%"></div>
                </div>
                <p id="health-tip" class="text-[10px] text-stone-400 italic text-center font-medium">è±ï¼Œä»Šå¤©å–äº†å¹¾æ¯ç”œç”œå‘¢ï¼Ÿ</p>
            </div>
        </div>

        <!-- å–œæ­¡çš„åº—å®¶èˆ‡é£²æ–™ç¨®é¡ (éœ€æ±‚ 7) -->
        <div class="grid grid-cols-2 gap-4">
            <div class="paper-card p-5 space-y-1 stat-card">
                <p class="text-[9px] font-black text-stone-300 uppercase tracking-widest">Favorite Shop</p>
                <p id="top-shop" class="text-sm font-black text-stone-600 truncate">å°šæœªæ¢ç´¢</p>
            </div>
            <div class="paper-card p-5 space-y-1 stat-card">
                <p class="text-[9px] font-black text-stone-300 uppercase tracking-widest">Drink Type</p>
                <p id="top-item" class="text-sm font-black text-stone-600 truncate">å°šæœªç´€éŒ„</p>
            </div>
        </div>

        <!-- æ—¥æ›†å€å¡Š -->
        <div class="paper-card p-6">
            <div class="grid grid-cols-7 text-center text-[9px] font-black text-stone-300 uppercase tracking-widest mb-5">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-2.5"></div>
        </div>

        <div class="h-10"></div>
    </div>

    <!-- ç´€éŒ„ç·¨è¼¯å½ˆçª— (éœ€æ±‚ 1, 2, 3, 4) -->
    <div id="modal-overlay" class="fixed inset-0 bg-stone-900/40 backdrop-blur-md hidden z-50 items-end justify-center">
        <div class="bg-white w-full max-w-md rounded-t-[44px] shadow-2xl p-8 space-y-6 max-h-[85vh] overflow-y-auto no-scrollbar border-t-8 border-[var(--m-beige)]">
            <div class="flex justify-between items-center pb-2">
                <div>
                    <h3 id="modal-date-title" class="text-xl font-black serif-title text-stone-700">è¨˜ä¸‹ä¸€æ¯ç¾å¥½</h3>
                    <p class="text-[10px] text-stone-400 font-bold tracking-widest uppercase mt-1">Daily Log Entry</p>
                </div>
                <button onclick="closeModal()" class="w-12 h-12 flex items-center justify-center bg-stone-50 rounded-full text-stone-400 btn-click shadow-sm">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="entries-container" class="space-y-8"></div>

            <button id="btn-save" onclick="saveToCloud()" class="btn-click w-full bg-[#5D544B] text-white py-4.5 rounded-[22px] font-bold text-lg shadow-xl shadow-stone-200">
                ä¿å­˜ç´€éŒ„è‡³é›²ç«¯
            </button>
            <div class="h-10"></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-12 left-1/2 -translate-x-1/2 bg-stone-800/90 text-white px-8 py-3.5 rounded-full text-[11px] font-bold shadow-2xl z-[100] opacity-0 pointer-events-none transition-all duration-300"></div>

    <script>
        const firebaseConfig = JSON.parse(__firebase_config);
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'xuan-drink-diary-v7';

        // éœ€æ±‚ 2, 3 çš„é¸é …
        const iceOpts = ['å›ºå®š', 'æ­£å¸¸', 'å°‘å†°', 'å¾®å†°', 'å»å†°', 'å¸¸æº«', 'ç†±çš„'];
        const sugarOpts = ['å›ºå®š', 'æ­£å¸¸', 'å°‘ç³–', 'åŠç³–', 'å¾®ç³–', 'ä¸€åˆ†', 'ç„¡ç³–'];
        const topOpts = ['çç ', 'æ³¢éœ¸', 'æ¤°æœ', 'èŠ‹åœ“', 'ä»™è‰', 'å¸ƒä¸'];

        let state = {
            user: null,
            viewDate: new Date(),
            records: {},
            activeKey: null,
            tempData: [{}, {}]
        };

        function initApp() {
            state.viewDate = new Date(); // å¼·åˆ¶åŒæ­¥ç•¶å‰æ—¥æœŸ
            updateMonthDisplay();
            renderCalendar();
            setGreeting();
            lucide.createIcons();
        }

        function updateMonthDisplay() {
            const y = state.viewDate.getFullYear(), m = state.viewDate.getMonth() + 1;
            document.getElementById('display-month').innerText = `${y} / ${String(m).padStart(2,'0')}`;
        }

        function setGreeting() {
            const hr = new Date().getHours();
            const g = hr < 11 ? "Good Morning, Xuan" : hr < 17 ? "Good Afternoon, Xuan" : "Good Evening, Xuan";
            document.getElementById('greeting').innerText = g;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const y = state.viewDate.getFullYear(), m = state.viewDate.getMonth();
            const first = new Date(y, m, 1).getDay();
            const days = new Date(y, m+1, 0).getDate();
            const today = new Date();
            const isCurrent = today.getFullYear() === y && today.getMonth() === m;

            for(let i=0; i<first; i++) grid.appendChild(document.createElement('div'));
            for(let d=1; d<=days; d++) {
                const key = `${y}-${m+1}-${d}`;
                const hasData = (state.records[key] || []).some(r => r.item);
                const isToday = isCurrent && today.getDate() === d;
                const btn = document.createElement('button');
                btn.onclick = () => openModal(key);
                btn.className = `calendar-day btn-click ${hasData ? 'bg-stone-800 text-white font-black' : isToday ? 'border-2 border-stone-800 text-stone-800 font-black' : 'text-stone-400 hover:bg-white'}`;
                btn.innerHTML = `<span>${d}</span>${hasData ? '<div class="dot"></div>' : ''}`;
                grid.appendChild(btn);
            }
        }

        async function forceSync() {
            const icon = document.getElementById('sync-icon');
            const text = document.getElementById('sync-text');
            icon.classList.add('animate-spin');
            text.innerText = "åŒæ­¥ä¸­...";
            
            if(!state.user) await auth.signInAnonymously();
            
            const ref = db.collection('artifacts').doc(appId).collection('users').doc(state.user.uid).collection('settings').doc('main');
            const snap = await ref.get();
            if(snap.exists) state.records = snap.data().records || {};
            
            renderCalendar();
            updateStats();
            icon.classList.remove('animate-spin');
            text.innerText = "å·²é€£ç·š";
            lucide.createIcons();
        }

        // çµ±è¨ˆé‚è¼¯ (éœ€æ±‚ 1, 7)
        function updateStats() {
            const y = state.viewDate.getFullYear(), m = state.viewDate.getMonth() + 1;
            let priceTotal = 0, cupsTotal = 0, penalty = 0;
            let itemCounts = {}, shopCounts = {};

            Object.keys(state.records).forEach(key => {
                if(key.startsWith(`${y}-${m}-`)) {
                    (state.records[key] || []).forEach(r => {
                        if(r.item) {
                            priceTotal += Number(r.price || 0);
                            cupsTotal++;
                            itemCounts[r.item] = (itemCounts[r.item] || 0) + 1;
                            if(r.shop) shopCounts[r.shop] = (shopCounts[r.shop] || 0) + 1;
                            
                            // å¥åº·æ‰£åˆ†é‚è¼¯
                            if(['æ­£å¸¸', 'å›ºå®š', 'å°‘ç³–'].includes(r.sugar)) penalty += 20;
                            else if(r.sugar === 'åŠç³–') penalty += 10;
                            else if(['å¾®ç³–', 'ä¸€åˆ†'].includes(r.sugar)) penalty += 5;
                        }
                    });
                }
            });

            document.getElementById('stat-price').innerText = priceTotal;
            document.getElementById('stat-cups').innerText = cupsTotal;
            
            const topShopArr = Object.entries(shopCounts).sort((a,b)=>b[1]-a[1])[0];
            const topItemArr = Object.entries(itemCounts).sort((a,b)=>b[1]-a[1])[0];
            document.getElementById('top-shop').innerText = topShopArr ? topShopArr[0] : 'å°šæœªæ¢ç´¢';
            document.getElementById('top-item').innerText = topItemArr ? topItemArr[0] : 'å°šæœªç´€éŒ„';

            const score = Math.max(0, 100 - penalty);
            document.getElementById('health-score-text').innerText = score + '%';
            document.getElementById('health-progress').style.width = score + '%';
            
            const tip = document.getElementById('health-tip');
            if(score > 80) tip.innerText = "ä»Šæ—¥å¥åº·æ»¿åˆ†ï¼Œå¿ƒæƒ…ä¹Ÿæ»¿åˆ†ï¼âœ¨";
            else if(score > 50) tip.innerText = "ç¨å¾®ä¼‘æ¯ä¸€ä¸‹ï¼Œå¤šå–é»ç™½é–‹æ°´å–”ã€‚ğŸµ";
            else tip.innerText = "è­¦å‘Šï¼é€™æœˆç³–åˆ†æ”å–æœ‰é»è¶…æ¨™å›‰ã€‚ğŸš«";
        }

        function openModal(key) {
            state.activeKey = key;
            const p = key.split('-');
            document.getElementById('modal-date-title').innerText = `${p[1]}æœˆ${p[2]}æ—¥`;
            state.tempData = JSON.parse(JSON.stringify(state.records[key] || [{}, {}]));
            renderEntries();
            document.getElementById('modal-overlay').classList.replace('hidden', 'flex');
            lucide.createIcons();
        }

        function closeModal() { document.getElementById('modal-overlay').classList.replace('flex', 'hidden'); }

        // æ¸²æŸ“ç·¨è¼¯å¡ç‰‡ (éœ€æ±‚ 1, 2, 3, 4)
        function renderEntries() {
            const container = document.getElementById('entries-container');
            container.innerHTML = '';
            state.tempData.forEach((data, idx) => {
                const section = document.createElement('div');
                section.className = "bg-stone-50/70 p-6 rounded-[32px] space-y-5 border border-white shadow-sm";
                section.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="text-[10px] font-black text-stone-300 tracking-[0.2em]">RECORD NO.${idx+1}</span>
                        <div class="bg-white px-4 py-1.5 rounded-full border border-stone-100 flex items-center gap-1.5 shadow-sm">
                            <span class="text-[11px] font-bold text-stone-400">$</span>
                            <input type="number" value="${data.price||''}" oninput="updateTemp(${idx}, 'price', this.value)" class="w-12 text-sm font-black outline-none bg-transparent text-stone-600" placeholder="0">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <p class="text-[9px] font-bold text-stone-400 ml-1">SHOP</p>
                            <input type="text" value="${data.shop||''}" oninput="updateTemp(${idx}, 'shop', this.value)" class="w-full p-4 bg-white rounded-2xl text-xs outline-none shadow-sm border border-stone-100" placeholder="åº—å®¶">
                        </div>
                        <div class="space-y-1">
                            <p class="text-[9px] font-bold text-stone-400 ml-1">DRINK</p>
                            <input type="text" value="${data.item||''}" oninput="updateTemp(${idx}, 'item', this.value)" class="w-full p-4 bg-white rounded-2xl text-xs outline-none shadow-sm border border-stone-100" placeholder="å“é …">
                        </div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-[9px] font-bold text-stone-400 ml-1 uppercase">Ice Level</p>
                        <div class="flex flex-wrap gap-2">${iceOpts.map(o => `<button onclick="updateTemp(${idx}, 'ice', '${o}')" class="option-btn ${data.ice===o?'active-ice':''}">${o}</button>`).join('')}</div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-[9px] font-bold text-stone-400 ml-1 uppercase">Sugar Level</p>
                        <div class="flex flex-wrap gap-2">${sugarOpts.map(o => `<button onclick="updateTemp(${idx}, 'sugar', '${o}')" class="option-btn ${data.sugar===o?'active-sugar':''}">${o}</button>`).join('')}</div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-[9px] font-bold text-stone-400 ml-1 uppercase">Toppings</p>
                        <div class="flex flex-wrap gap-2">${topOpts.map(o => `<button onclick="toggleTop(${idx}, '${o}')" class="option-btn ${(data.tops||[]).includes(o)?'active-top':''}">${o}</button>`).join('')}</div>
                        <input type="text" value="${data.customTop||''}" oninput="updateTemp(${idx}, 'customTop', this.value)" class="w-full p-4 bg-white rounded-2xl text-[11px] outline-none border border-stone-100 mt-2 shadow-inner" placeholder="è‡ªå¡«å…¶ä»–åŠ æ–™ (éœ€æ±‚ 4)">
                    </div>
                `;
                container.appendChild(section);
            });
        }

        function updateTemp(idx, f, v) { state.tempData[idx][f] = v; if(['ice','sugar'].includes(f)) renderEntries(); }
        function toggleTop(idx, v) { 
            let t = state.tempData[idx].tops || []; 
            state.tempData[idx].tops = t.includes(v) ? t.filter(x=>x!==v) : [...t, v]; 
            renderEntries(); 
        }

        async function saveToCloud() {
            if(!state.user) return showToast("é€£ç·šä¸­...");
            const btn = document.getElementById('btn-save');
            btn.innerText = "åŒæ­¥è‡³é›²ç«¯..."; btn.disabled = true;
            try {
                const newRecords = { ...state.records, [state.activeKey]: state.tempData };
                const ref = db.collection('artifacts').doc(appId).collection('users').doc(state.user.uid).collection('settings').doc('main');
                await ref.set({ records: newRecords }, { merge: true });
                state.records = newRecords;
                renderCalendar();
                updateStats();
                closeModal();
                showToast("âœ¨ å‚™ä»½æˆåŠŸ");
            } catch(e) { showToast("é€£ç·šç•°å¸¸"); }
            finally { btn.innerText = "ä¿å­˜ç´€éŒ„è‡³é›²ç«¯"; btn.disabled = false; }
        }

        function showToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 2500);
        }

        function changeMonth(s) { state.viewDate.setMonth(state.viewDate.getMonth() + s); updateMonthDisplay(); renderCalendar(); updateStats(); }

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') initApp();
        });

        window.onload = async () => {
            initApp();
            auth.onAuthStateChanged(user => {
                state.user = user;
                if(user) forceSync();
                else auth.signInAnonymously();
            });
        };
    </script>
</body>
</html>


