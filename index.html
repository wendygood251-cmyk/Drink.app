<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>è±ã®é£²æ–™æ—¥èªŒ</title>
    
    <!-- PWA é…ç½® -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="è±ã®æ—¥èªŒ">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' fill='%23E3D5CA'/%3E%3Cpath d='M75 55 L105 55 L100 135 C100 140 95 145 90 145 C85 145 80 140 80 135 Z' fill='none' stroke='%235D4037' stroke-width='6'/%3E%3Cpath d='M88 35 L95 55' stroke='%235D4037' stroke-width='4' stroke-linecap='round'/%3E%3Ccircle cx='95' cy='90' r='12' fill='%23D4A373' opacity='0.4'/%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700;900&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --bg-milktea: #F5EBE0; /* å¥¶èŒ¶åº•è‰² */
            --card-cream: #FFFFFF; /* å¥¶æ²¹ç™½ */
            --accent-roasted: #5D4037; /* ç„™èŒ¶æ£• */
            --accent-caramel: #D4A373; /* ç„¦ç³–è‰² */
            --morandi-rose: #B25D66; /* è«è˜­è¿ªç´… */
        }

        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-milktea); 
            color: var(--accent-roasted);
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            background-image: radial-gradient(rgba(93, 64, 55, 0.03) 1.5px, transparent 1.5px);
            background-size: 20px 20px;
        }

        .serif-title { font-family: 'Noto Serif TC', serif; }

        .card-shadow {
            background: var(--card-cream);
            border-radius: 30px;
            box-shadow: 0 12px 24px -8px rgba(93, 64, 55, 0.08);
            border: 1px solid rgba(93, 64, 55, 0.04);
        }

        /* è©•åˆ†é€£å‹•æ—¥æ›†èƒŒæ™¯ */
        .score-bg-5 { background-color: #EF9A9A !important; color: #7F0000; border-color: #E57373; }
        .score-bg-4 { background-color: #FFCDD2 !important; color: #B71C1C; border-color: #EF9A9A; }
        .score-bg-3 { background-color: #FFEBEE !important; color: #C62828; border-color: #FFCDD2; }
        .score-bg-2 { background-color: #FDF4F4 !important; color: #D32F2F; border-color: #FFEBEE; }
        .score-bg-1 { background-color: #FFFFFF !important; color: #E53935; border-color: #F1ECE9; }

        .calendar-day {
            aspect-ratio: 1;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.17, 0.67, 0.83, 0.67);
            border: 1px solid #E3D5CA;
            background: white;
        }
        .is-today { border: 2.5px solid var(--accent-roasted); font-weight: 900; transform: scale(1.05); }
        
        .option-chip {
            transition: all 0.15s ease-out;
            border-radius: 14px;
            font-size: 12px;
            padding: 9px 2px;
            border: 1.5px solid #F1ECE9;
            background: #FFFFFF;
            color: #A1887F;
            text-align: center;
            width: 100%;
        }
        .active-ice { background: #E3F2FD; border-color: #90CAF9; color: #1565C0; font-weight: bold; }
        .active-sugar { background: #FFEBEE; border-color: #FFCDD2; color: #C62828; font-weight: bold; }

        .modal-mask {
            backdrop-filter: blur(12px);
            background: rgba(93, 64, 55, 0.3);
        }

        @keyframes slideIn { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide { animation: slideIn 0.35s cubic-bezier(0.2, 0.8, 0.2, 1); }

        .health-gradient {
            background: linear-gradient(90deg, #D4A373 0%, #B25D66 100%);
            transition: width 1s ease-in-out;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        input { font-size: 16px !important; } 
    </style>
</head>
<body class="p-4 pb-12">

    <div id="app" class="max-w-md mx-auto space-y-6">
        <!-- é ‚éƒ¨æ¨™é¡Œèˆ‡ç‹€æ…‹ -->
        <header class="flex justify-between items-center px-1 pt-6">
            <div class="flex-1">
                <p id="today-text" class="text-[10px] font-bold text-[#A1887F] tracking-[0.2em] uppercase mb-1">Xuan's Diary</p>
                <h1 class="text-3xl font-black serif-title text-[#5D4037]">è±ã®é£²æ–™æ—¥èªŒ</h1>
            </div>
            <!-- ä¿®æ­£å¾Œçš„ç‹€æ…‹æŒ‡ç¤ºç‡ˆ -->
            <div class="flex items-center gap-2 bg-white/80 px-3 py-1.5 rounded-full border border-[#E3D5CA] shadow-sm shrink-0">
                <div id="sync-dot" class="w-2 h-2 rounded-full bg-stone-300"></div>
                <span id="sync-label" class="text-[9px] font-black text-[#A1887F] whitespace-nowrap">é€£ç·šä¸­</span>
            </div>
        </header>

        <!-- å„€è¡¨æ¿ -->
        <div class="card-shadow p-6 space-y-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3 bg-[#F5EBE0] px-4 py-2 rounded-2xl border border-[#E3D5CA]">
                    <button onclick="changeMonth(-1)"><i data-lucide="chevron-left" class="w-4 h-4 text-[#A1887F]"></i></button>
                    <span id="month-label" class="text-xs font-black min-w-[75px] text-center text-[#5D4037]">2024 / 01</span>
                    <button onclick="changeMonth(1)"><i data-lucide="chevron-right" class="w-4 h-4 text-[#A1887F]"></i></button>
                </div>
                <div class="w-10 h-10 bg-white rounded-2xl flex items-center justify-center border border-[#E3D5CA] shadow-sm">
                    <i data-lucide="coffee" class="w-5 h-5 text-[#D4A373]"></i>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-[#FDF8F5] p-5 rounded-3xl border border-[#F1ECE9]">
                    <p class="text-[9px] font-bold text-[#A1887F] uppercase tracking-widest mb-1">æœ¬æœˆèŠ±è²»</p>
                    <p class="text-2xl font-black text-[#5D4037] tracking-tighter">$<span id="stat-price">0</span></p>
                </div>
                <div class="bg-[#FDF8F5] p-5 rounded-3xl border border-[#F1ECE9]">
                    <p class="text-[9px] font-bold text-[#A1887F] uppercase tracking-widest mb-1">æœ¬æœˆæ¯æ•¸</p>
                    <p class="text-2xl font-black text-[#5D4037] tracking-tighter"><span id="stat-cups">0</span> <span class="text-xs font-bold">æ¯</span></p>
                </div>
            </div>

            <div class="space-y-4">
                <div class="flex justify-between items-end px-1">
                    <span class="text-[11px] font-bold text-[#5D4037] flex items-center gap-1.5 uppercase tracking-wide">
                        <i data-lucide="activity" class="w-3.5 h-3.5 text-[#B25D66]"></i> å¥åº·æŒ‡æ•¸
                    </span>
                    <span id="health-percent" class="text-xs font-black text-[#A1887F]">100%</span>
                </div>
                <div class="w-full h-3 bg-[#F5EBE0] rounded-full overflow-hidden p-[2px] border border-[#E3D5CA]">
                    <div id="health-bar" class="h-full rounded-full health-gradient shadow-sm" style="width: 100%"></div>
                </div>
                <div class="bg-[#F5EBE0]/60 rounded-3xl p-4 border border-dashed border-[#D4A373]/40">
                    <p id="health-msg" class="text-[11px] text-[#8D6E63] text-center italic font-bold leading-relaxed">ã€Œå–ä¸‹ä¸€å£å¥¶èŒ¶ï¼Œå¿ƒæƒ…ä¹Ÿæ˜¯ç”œç”œçš„ã€‚ã€</p>
                </div>
            </div>
        </div>

        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="grid grid-cols-2 gap-4">
            <div class="card-shadow p-5 space-y-2 border-b-4 border-[#D4A373]">
                <p class="text-[8px] font-black text-[#A1887F] tracking-widest uppercase">æœ€æ„›çš„åº—å®¶</p>
                <p id="top-shop" class="text-xs font-bold text-[#5D4037] truncate">å°šæœªç´€éŒ„</p>
            </div>
            <div class="card-shadow p-5 space-y-2 border-b-4 border-[#B25D66]">
                <p class="text-[8px] font-black text-[#A1887F] tracking-widest uppercase">é£²æ–™ç¨®é¡</p>
                <p id="top-type" class="text-xs font-bold text-[#5D4037] truncate">å°šæœªç´€éŒ„</p>
            </div>
        </div>

        <!-- æ—¥æ›†å€å¡Š -->
        <div class="card-shadow p-5">
            <div class="grid grid-cols-7 text-center text-[9px] font-black text-[#A1887F] uppercase mb-4 tracking-wider">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-3"></div>
        </div>
    </div>

    <!-- ç·¨è¼¯å½ˆçª— -->
    <div id="modal-overlay" class="fixed inset-0 modal-mask hidden z-50 items-end justify-center">
        <div class="bg-white w-full max-w-md rounded-t-[48px] p-6 space-y-6 max-h-[94vh] overflow-y-auto no-scrollbar animate-slide border-t-8 border-[#F5EBE0] overflow-x-hidden">
            <div class="flex justify-between items-center">
                <div>
                    <h3 id="modal-title" class="text-2xl font-black serif-title text-[#5D4037]">é£²å“æ—¥èªŒ</h3>
                    <p id="modal-date" class="text-[10px] text-[#A1887F] font-bold uppercase tracking-widest mt-0.5"></p>
                </div>
                <button onclick="closeModal()" class="w-12 h-12 bg-[#F5EBE0] rounded-full flex items-center justify-center text-[#A1887F]">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="entry-container" class="space-y-6"></div>

            <button onclick="addEntry()" class="w-full py-5 border-2 border-dashed border-[#E3D5CA] rounded-[32px] text-[#A1887F] text-[11px] font-black flex items-center justify-center gap-2 active:bg-[#F5EBE0] transition-colors">
                <i data-lucide="plus" class="w-4 h-4"></i> å†è¨˜éŒ„ä¸€æ¯é£²å“
            </button>

            <div class="grid grid-cols-2 gap-4 pt-2">
                <button onclick="deleteDay()" class="py-5 bg-[#F5EBE0] text-[#A1887F] rounded-3xl font-black text-sm active:scale-95 transition-transform">
                    åˆªé™¤å…¨æ—¥
                </button>
                <button onclick="saveDay()" class="py-5 bg-[#5D4037] text-white rounded-3xl font-black text-sm shadow-xl shadow-[#D4A373]/30 active:scale-95 transition-transform">
                    ä¿å­˜ä¿®æ”¹
                </button>
            </div>
            <div class="h-10"></div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-[#5D4037] text-white px-8 py-3 rounded-full text-[11px] font-bold tracking-widest z-[100] opacity-0 pointer-events-none transition-all duration-500 shadow-2xl border border-[#D4A373]"></div>

    <script>
        const ICE_LIST = ['å›ºå®š', 'æ­£å¸¸', 'å°‘å†°', 'å¾®å†°', 'å»å†°', 'å¸¸æº«', 'ç†±çš„'];
        const SUGAR_LIST = ['å›ºå®š', 'æ­£å¸¸', 'å°‘ç³–', 'åŠç³–', 'å¾®ç³–', 'ä¸€åˆ†', 'ç„¡ç³–'];
        const MESSAGES = {
            perfect: ["ä»Šå¤©çš„ä½ ä¾ç„¶é–ƒé–ƒç™¼å…‰å”·ï¼âœ¨", "100% çš„è‡ªå¾‹ï¼Œçµ¦è±ä¸€å€‹è®šï¼", "å–ä¸‹ä¸€å£å¥¶èŒ¶ï¼Œå¿ƒæƒ…ä¹Ÿæ˜¯ç”œç”œçš„ã€‚"],
            good: ["å¾®ç”œçš„ç”Ÿæ´»ï¼Œä¹Ÿæ˜¯ä¸€ç¨®å°ç¢ºå¹¸ã€‚", "è¡¨ç¾ä¸éŒ¯å”·ï¼Œè¨˜å¾—å¤šå–é»ç™½é–‹æ°´ã€‚", "å¹³è¡¡å¾—å‰›å¥½ï¼Œæ˜å¤©çš„ä½ ä¹Ÿæœƒå¾ˆæ£’ï¼"],
            warning: ["ç³–åˆ†ç¨å¾®å¤šäº†ä¸€é»ï¼Œä»Šå¤©å¤šå‹•å‹•å§ï¼Ÿ", "ç”œåº¦è­¦å ±ï¼ä¸‹ä¸€æ¯è©¦è©¦çœ‹å¾®ç³–å¦‚ä½•ï¼Ÿ"],
            danger: ["å“å‘€ï¼ç³–åˆ†è¶…æ¨™å•¦ï¼æ˜å¤©è¦æŒ‘æˆ°ç„¡ç³–å”·ã€‚", "ç‚ºäº†å¥åº·çš„èº«é«”ï¼Œä»Šå¤©è¦å…‹åˆ¶ä¸€ä¸‹å”·ã€‚"]
        };

        let state = {
            viewDate: new Date(),
            records: JSON.parse(localStorage.getItem('xuan_final_v7') || '{}'),
            activeKey: null,
            tempEntries: [],
            user: null
        };

        // Firebase åˆå§‹åŒ–
        try {
            const firebaseConfig = JSON.parse(__firebase_config);
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'xuan-drink-diary-v7';

            async function initAuth() {
                try {
                    const userCred = await auth.signInAnonymously();
                    state.user = userCred.user;
                    document.getElementById('sync-dot').className = "w-2 h-2 rounded-full bg-green-500";
                    document.getElementById('sync-label').innerText = "é›²ç«¯åŒæ­¥ä¸­";
                    
                    const doc = await db.collection('artifacts').doc(appId).collection('users').doc(state.user.uid).collection('settings').doc('data').get();
                    if (doc.exists) {
                        state.records = { ...state.records, ...doc.data().records };
                        saveLocal();
                        renderCalendar();
                    }
                } catch (e) { document.getElementById('sync-label').innerText = "æœ¬åœ°ç´€éŒ„"; }
            }
            initAuth();
        } catch(e) { document.getElementById('sync-label').innerText = "æœ¬åœ°ç´€éŒ„"; }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const y = state.viewDate.getFullYear(), m = state.viewDate.getMonth();
            const daysCount = new Date(y, m+1, 0).getDate();
            const firstDay = new Date(y, m, 1).getDay();
            
            document.getElementById('month-label').innerText = `${y} / ${String(m+1).padStart(2,'0')}`;
            
            for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));
            
            for(let d=1; d<=daysCount; d++) {
                const key = `${y}-${m+1}-${d}`;
                const list = state.records[key] || [];
                const hasData = list.length > 0;
                
                let scoreClass = '';
                if(hasData) {
                    const avg = Math.round(list.reduce((a,b) => a + (b.score||0), 0) / list.length);
                    scoreClass = `score-bg-${avg || 1}`;
                }

                const btn = document.createElement('button');
                btn.className = `calendar-day ${scoreClass} ${isToday(y,m,d)?'is-today':''}`;
                btn.innerText = d;
                btn.onclick = () => openModal(key);
                grid.appendChild(btn);
            }
            updateStats();
        }

        function openModal(key) {
            state.activeKey = key;
            state.tempEntries = JSON.parse(JSON.stringify(state.records[key] || [{}]));
            if(state.tempEntries.length === 0) state.tempEntries = [{}];
            
            document.getElementById('modal-date').innerText = key.replace(/-/g, ' . ');
            renderEntries();
            document.getElementById('modal-overlay').classList.replace('hidden', 'flex');
            lucide.createIcons();
        }

        function renderEntries() {
            const container = document.getElementById('entry-container');
            container.innerHTML = '';
            
            state.tempEntries.forEach((entry, idx) => {
                const card = document.createElement('div');
                card.className = "bg-[#F5EBE0]/40 border border-[#E3D5CA] p-5 rounded-[40px] space-y-5 relative overflow-hidden";
                card.innerHTML = `
                    <div class="flex justify-between items-center px-1">
                        <span class="text-[9px] font-black text-[#A1887F] uppercase tracking-[0.2em]">Item #${idx+1}</span>
                        <div class="flex items-center gap-2">
                            <div class="bg-white border border-[#E3D5CA] rounded-2xl px-3 py-1.5 flex items-center gap-1 shadow-sm">
                                <span class="text-[10px] font-bold text-[#A1887F]">$</span>
                                <input type="number" value="${entry.price||''}" oninput="updateTemp(${idx},'price',this.value)" class="w-12 text-xs font-black outline-none bg-transparent text-[#5D4037]" placeholder="0">
                            </div>
                            ${idx > 0 ? `<button onclick="removeEntry(${idx})" class="w-8 h-8 bg-white border border-[#E3D5CA] text-stone-300 rounded-full flex items-center justify-center active:bg-rose-50"><i data-lucide="minus-circle" class="w-4 h-4"></i></button>` : ''}
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" value="${entry.shop||''}" oninput="updateTemp(${idx},'shop',this.value)" placeholder="åº—å®¶åç¨±" class="w-full bg-white border border-[#E3D5CA] rounded-2xl px-4 py-4 text-xs outline-none focus:border-[#D4A373] transition-all">
                        <input type="text" value="${entry.item||''}" oninput="updateTemp(${idx},'item',this.value)" placeholder="é£²å“ç¨®é¡" class="w-full bg-white border border-[#E3D5CA] rounded-2xl px-4 py-4 text-xs outline-none focus:border-[#D4A373] transition-all">
                    </div>

                    <div class="space-y-2">
                        <p class="text-[9px] font-bold text-[#A1887F] uppercase ml-1 tracking-wider">å†°å¡Š</p>
                        <div class="grid grid-cols-4 gap-2">
                            ${ICE_LIST.map(o => `<button onclick="updateTemp(${idx},'ice','${o}')" class="option-chip ${entry.ice===o?'active-ice':''}">${o}</button>`).join('')}
                        </div>
                    </div>

                    <div class="space-y-2">
                        <p class="text-[9px] font-bold text-[#A1887F] uppercase ml-1 tracking-wider">ç”œåº¦</p>
                        <div class="grid grid-cols-4 gap-2">
                            ${SUGAR_LIST.map(o => `<button onclick="updateTemp(${idx},'sugar','${o}')" class="option-chip ${entry.sugar===o?'active-sugar':''}">${o}</button>`).join('')}
                        </div>
                    </div>

                    <div class="space-y-4 pt-2 border-t border-[#E3D5CA]/50">
                        <div class="space-y-1.5">
                            <p class="text-[9px] font-bold text-[#A1887F] uppercase ml-1 tracking-wider">åŠ æ–™ (è‡ªå¡«)</p>
                            <input type="text" value="${entry.topping||''}" oninput="updateTemp(${idx},'topping',this.value)" placeholder="ä¾‹ï¼šçç ã€ä»™è‰..." class="w-full bg-white border border-[#E3D5CA] rounded-2xl px-4 py-4 text-xs outline-none focus:border-[#D4A373]">
                        </div>
                        
                        <div class="space-y-2">
                            <p class="text-[9px] font-bold text-[#A1887F] uppercase ml-1 tracking-wider text-center">çµ¦é€™æ¯é£²æ–™è©•åˆ†</p>
                            <div class="bg-white border border-[#E3D5CA] rounded-3xl p-4 flex justify-around shadow-sm">
                                ${[1,2,3,4,5].map(s => `
                                    <button onclick="updateTemp(${idx},'score',${s})" class="transition-transform active:scale-150 transform">
                                        <i data-lucide="star" class="w-8 h-8 ${entry.score >= s ? 'fill-[#E57373] text-[#E57373]' : 'text-stone-100'}"></i>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        function updateTemp(idx, field, val) {
            state.tempEntries[idx][field] = val;
            if(['ice', 'sugar', 'score'].includes(field)) renderEntries();
        }

        function addEntry() { state.tempEntries.push({}); renderEntries(); }
        function removeEntry(idx) { state.tempEntries.splice(idx, 1); renderEntries(); }

        async function saveDay() {
            const valid = state.tempEntries.filter(e => e.item || e.shop);
            if(valid.length === 0) delete state.records[state.activeKey];
            else state.records[state.activeKey] = valid;
            await syncCloud();
            saveLocal();
            renderCalendar();
            closeModal();
            showToast("æ—¥èªŒå·²ä¿å­˜ âœ¨");
        }

        async function deleteDay() {
            delete state.records[state.activeKey];
            await syncCloud();
            saveLocal();
            renderCalendar();
            closeModal();
            showToast("å·²æ¸…ç©ºç•¶æ—¥ç´€éŒ„ ğŸ—‘ï¸");
        }

        async function syncCloud() {
            if(!state.user) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'xuan-drink-diary-v7';
            try {
                await firebase.firestore().collection('artifacts').doc(appId).collection('users').doc(state.user.uid).collection('settings').doc('data').set({
                    records: state.records
                }, { merge: true });
            } catch (e) { console.error(e); }
        }

        function updateStats() {
            const y = state.viewDate.getFullYear(), m = state.viewDate.getMonth() + 1;
            let price = 0, cups = 0, penalty = 0, shops = {}, items = {};
            
            Object.keys(state.records).forEach(key => {
                if(key.startsWith(`${y}-${m}-`)) {
                    state.records[key].forEach(r => {
                        price += Number(r.price || 0);
                        cups += 1;
                        if(r.shop) shops[r.shop] = (shops[r.shop]||0)+1;
                        if(r.item) items[r.item] = (items[r.item]||0)+1;
                        if(['æ­£å¸¸','å›ºå®š','å°‘ç³–'].includes(r.sugar)) penalty += 20;
                        else if(r.sugar === 'åŠç³–') penalty += 10;
                        else if(r.sugar === 'å¾®ç³–') penalty += 5;
                        else if(r.sugar === 'ä¸€åˆ†') penalty += 2;
                    });
                }
            });

            document.getElementById('stat-price').innerText = price.toLocaleString();
            document.getElementById('stat-cups').innerText = cups;
            const score = Math.max(0, 100 - penalty);
            document.getElementById('health-percent').innerText = score + '%';
            document.getElementById('health-bar').style.width = score + '%';
            
            let cat = 'perfect';
            if(score < 60) cat = 'danger';
            else if(score < 80) cat = 'warning';
            else if(score < 100) cat = 'good';
            const msgs = MESSAGES[cat];
            document.getElementById('health-msg').innerText = msgs[new Date().getDate() % msgs.length];

            document.getElementById('top-shop').innerText = Object.entries(shops).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'å°šæœªç´€éŒ„';
            document.getElementById('top-type').innerText = Object.entries(items).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'å°šæœªç´€éŒ„';
        }

        function isToday(y,m,d) {
            const t = new Date();
            return t.getFullYear()===y && t.getMonth()===m && t.getDate()===d;
        }

        function saveLocal() { localStorage.setItem('xuan_final_v7', JSON.stringify(state.records)); }
        function closeModal() { document.getElementById('modal-overlay').classList.replace('flex', 'hidden'); }
        function changeMonth(s) { state.viewDate.setMonth(state.viewDate.getMonth() + s); renderCalendar(); }
        function showToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 2500);
        }

        window.onload = () => {
            const now = new Date();
            document.getElementById('today-text').innerText = `Xuan Â· ${now.getMonth()+1}/${now.getDate()}`;
            renderCalendar();
            lucide.createIcons();
        };
    </script>
</body>
</html>

